{% extends 'grants/base.html' %}
{% load static %}

{% block title %}Applications - Granted{% endblock %}

{% block extra_css %}
<style>
    .applications-page {
        max-width: 1400px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-header h1 {
        font-size: 28px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .kanban-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
        margin-bottom: 32px;
    }

    .kanban-column {
        background: var(--bg-white);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 20px;
        min-height: 400px;
        display: flex;
        flex-direction: column;
    }

    .kanban-column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }

    .kanban-column-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .kanban-column-count {
        background: var(--bg-gray-light);
        color: var(--text-gray);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .kanban-column.in-progress .kanban-column-header {
        border-bottom-color: var(--primary-blue);
    }

    .kanban-column.in-progress .kanban-column-title {
        color: var(--primary-blue);
    }

    .kanban-column.submitted .kanban-column-header {
        border-bottom-color: #9333EA;
    }

    .kanban-column.submitted .kanban-column-title {
        color: #9333EA;
    }

    .kanban-column.approved .kanban-column-header {
        border-bottom-color: var(--secondary-green);
    }

    .kanban-column.approved .kanban-column-title {
        color: var(--secondary-green);
    }

    .kanban-column.rejected .kanban-column-header {
        border-bottom-color: #EF4444;
    }

    .kanban-column.rejected .kanban-column-title {
        color: #EF4444;
    }

    .kanban-column-content {
        flex: 1;
        min-height: 200px;
    }

    .application-card {
        background: var(--bg-white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: move;
        transition: all 0.2s;
        position: relative;
    }

    .application-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .application-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    .application-card-header {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
    }

    .application-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: white;
        background: var(--primary-blue);
        flex-shrink: 0;
    }

    .application-info {
        flex: 1;
        min-width: 0;
    }

    .application-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
        line-height: 1.4;
        word-wrap: break-word;
    }

    .application-funding {
        font-size: 16px;
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 8px;
    }

    .application-deadline {
        font-size: 12px;
        color: var(--text-gray);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .application-progress {
        margin-bottom: 8px;
    }

    .progress-bar-container {
        height: 6px;
        background: var(--bg-gray-light);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 4px;
    }

    .progress-bar {
        height: 100%;
        background: var(--primary-blue);
        border-radius: 3px;
        transition: width 0.3s;
    }

    .progress-percentage {
        font-size: 11px;
        color: var(--text-gray);
        font-weight: 500;
    }

    .application-updated {
        font-size: 11px;
        color: var(--text-light);
        margin-top: 8px;
    }

    .empty-column {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-light);
        font-size: 14px;
    }

    .tip-box {
        background: #EFF6FF;
        border: 1px solid var(--primary-blue);
        border-radius: 8px;
        padding: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        margin-top: 32px;
    }

    .tip-icon {
        color: var(--primary-blue);
        flex-shrink: 0;
        margin-top: 2px;
    }

    .tip-content {
        flex: 1;
    }

    .tip-content strong {
        display: block;
        color: var(--text-dark);
        margin-bottom: 4px;
        font-size: 14px;
    }

    .tip-content p {
        color: var(--text-gray);
        font-size: 13px;
        margin: 0;
        line-height: 1.5;
    }

    .kanban-column.drag-over {
        background: var(--bg-gray-light);
        border-color: var(--primary-blue);
    }

    @media (max-width: 1200px) {
        .kanban-board {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .kanban-board {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="applications-page">
    <div class="page-header">
        <h1>Manage and track all your grant applications</h1>
    </div>

    <div class="kanban-board" id="kanbanBoard">
        <!-- In Progress Column -->
        <div class="kanban-column in-progress" data-status="in_progress">
            <div class="kanban-column-header">
                <span class="kanban-column-title">In Progress</span>
                <span class="kanban-column-count">{{ status_groups.in_progress|length }}</span>
            </div>
            <div class="kanban-column-content" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                {% for application in status_groups.in_progress %}
                <div class="application-card" draggable="true" ondragstart="handleDragStart(event)" data-application-id="{{ application.id }}">
                    <div class="application-card-header">
                        <div class="application-icon">{{ application.grant.agency.acronym|slice:":3"|upper }}</div>
                        <div class="application-info">
                            <div class="application-title">{{ application.grant.title }}</div>
                        </div>
                    </div>
                    <div class="application-funding">
                        {% if application.grant.funding_min and application.grant.funding_max %}
                            ${{ application.grant.funding_min|floatformat:0 }}K - ${{ application.grant.funding_max|floatformat:0 }}K SGD
                        {% elif application.grant.funding_min %}
                            ${{ application.grant.funding_min|floatformat:0 }}K+ SGD
                        {% else %}
                            Amount not specified
                        {% endif %}
                    </div>
                    <div class="application-deadline">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                            <rect x="2" y="2" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1"/>
                            <path d="M4 1V3M8 1V3M2 5H10" stroke="currentColor" stroke-width="1"/>
                        </svg>
                        {% if application.grant.closing_date %}
                            {{ application.grant.closing_date|date:"d M Y" }}
                        {% else %}
                            TBA
                        {% endif %}
                    </div>
                    <div class="application-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 65%"></div>
                        </div>
                        <div class="progress-percentage">65%</div>
                    </div>
                    <div class="application-updated">Updated {{ application.updated_at|date:"d M" }}</div>
                </div>
                {% empty %}
                <div class="empty-column">No applications</div>
                {% endfor %}
            </div>
        </div>

        <!-- Submitted (In Review) Column -->
        <div class="kanban-column submitted" data-status="submitted">
            <div class="kanban-column-header">
                <span class="kanban-column-title">Submitted (In Review)</span>
                <span class="kanban-column-count">{{ status_groups.submitted|length }}</span>
            </div>
            <div class="kanban-column-content" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                {% for application in status_groups.submitted %}
                <div class="application-card" draggable="true" ondragstart="handleDragStart(event)" data-application-id="{{ application.id }}">
                    <div class="application-card-header">
                        <div class="application-icon">{{ application.grant.agency.acronym|slice:":3"|upper }}</div>
                        <div class="application-info">
                            <div class="application-title">{{ application.grant.title }}</div>
                        </div>
                    </div>
                    <div class="application-funding">
                        {% if application.grant.funding_min and application.grant.funding_max %}
                            ${{ application.grant.funding_min|floatformat:0 }}K - ${{ application.grant.funding_max|floatformat:0 }}K SGD
                        {% elif application.grant.funding_min %}
                            ${{ application.grant.funding_min|floatformat:0 }}K+ SGD
                        {% else %}
                            Amount not specified
                        {% endif %}
                    </div>
                    <div class="application-deadline">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                            <rect x="2" y="2" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1"/>
                            <path d="M4 1V3M8 1V3M2 5H10" stroke="currentColor" stroke-width="1"/>
                        </svg>
                        {% if application.grant.closing_date %}
                            {{ application.grant.closing_date|date:"d M Y" }}
                        {% else %}
                            TBA
                        {% endif %}
                    </div>
                    <div class="application-progress">
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 100%"></div>
                        </div>
                        <div class="progress-percentage">100%</div>
                    </div>
                    <div class="application-updated">Updated {{ application.updated_at|date:"d M" }}</div>
                </div>
                {% empty %}
                <div class="empty-column">No applications</div>
                {% endfor %}
            </div>
        </div>

        <!-- Approved Column -->
        <div class="kanban-column approved" data-status="approved">
            <div class="kanban-column-header">
                <span class="kanban-column-title">Approved</span>
                <span class="kanban-column-count">{{ status_groups.approved|length }}</span>
            </div>
            <div class="kanban-column-content" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                {% for application in status_groups.approved %}
                <div class="application-card" draggable="true" ondragstart="handleDragStart(event)" data-application-id="{{ application.id }}">
                    <div class="application-card-header">
                        <div class="application-icon">{{ application.grant.agency.acronym|slice:":3"|upper }}</div>
                        <div class="application-info">
                            <div class="application-title">{{ application.grant.title }}</div>
                        </div>
                    </div>
                    <div class="application-funding">
                        {% if application.grant.funding_min and application.grant.funding_max %}
                            ${{ application.grant.funding_min|floatformat:0 }}K - ${{ application.grant.funding_max|floatformat:0 }}K SGD
                        {% elif application.grant.funding_min %}
                            ${{ application.grant.funding_min|floatformat:0 }}K+ SGD
                        {% else %}
                            Amount not specified
                        {% endif %}
                    </div>
                    <div class="application-deadline">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                            <rect x="2" y="2" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1"/>
                            <path d="M4 1V3M8 1V3M2 5H10" stroke="currentColor" stroke-width="1"/>
                        </svg>
                        {% if application.grant.closing_date %}
                            {{ application.grant.closing_date|date:"d M Y" }}
                        {% else %}
                            TBA
                        {% endif %}
                    </div>
                    <div class="application-updated">Updated {{ application.updated_at|date:"d M" }}</div>
                </div>
                {% empty %}
                <div class="empty-column">No applications</div>
                {% endfor %}
            </div>
        </div>

        <!-- Rejected Column -->
        <div class="kanban-column rejected" data-status="rejected">
            <div class="kanban-column-header">
                <span class="kanban-column-title">Rejected</span>
                <span class="kanban-column-count">{{ status_groups.rejected|length }}</span>
            </div>
            <div class="kanban-column-content" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                {% for application in status_groups.rejected %}
                <div class="application-card" draggable="true" ondragstart="handleDragStart(event)" data-application-id="{{ application.id }}">
                    <div class="application-card-header">
                        <div class="application-icon">{{ application.grant.agency.acronym|slice:":3"|upper }}</div>
                        <div class="application-info">
                            <div class="application-title">{{ application.grant.title }}</div>
                        </div>
                    </div>
                    <div class="application-funding">
                        {% if application.grant.funding_min and application.grant.funding_max %}
                            ${{ application.grant.funding_min|floatformat:0 }}K - ${{ application.grant.funding_max|floatformat:0 }}K SGD
                        {% elif application.grant.funding_min %}
                            ${{ application.grant.funding_min|floatformat:0 }}K+ SGD
                        {% else %}
                            Amount not specified
                        {% endif %}
                    </div>
                    <div class="application-deadline">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                            <rect x="2" y="2" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1"/>
                            <path d="M4 1V3M8 1V3M2 5H10" stroke="currentColor" stroke-width="1"/>
                        </svg>
                        {% if application.grant.closing_date %}
                            {{ application.grant.closing_date|date:"d M Y" }}
                        {% else %}
                            TBA
                        {% endif %}
                    </div>
                    <div class="application-updated">Updated {{ application.updated_at|date:"d M" }}</div>
                </div>
                {% empty %}
                <div class="empty-column">No applications</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Tip Box -->
    <div class="tip-box">
        <svg class="tip-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="currentColor"/>
        </svg>
        <div class="tip-content">
            <strong>Tip: Stay organized</strong>
            <p>Drag and drop cards to update their status. Keep track of deadlines to never miss an opportunity.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let draggedElement = null;
    let draggedApplicationId = null;

    function handleDragStart(e) {
        draggedElement = e.target;
        draggedApplicationId = e.target.getAttribute('data-application-id');
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.outerHTML);
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        
        const column = e.currentTarget.closest('.kanban-column');
        if (column) {
            column.classList.add('drag-over');
        }
        
        return false;
    }

    function handleDragLeave(e) {
        const column = e.currentTarget.closest('.kanban-column');
        if (column) {
            column.classList.remove('drag-over');
        }
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        e.preventDefault();

        const column = e.currentTarget.closest('.kanban-column');
        if (column) {
            column.classList.remove('drag-over');
        }

        if (draggedElement && draggedApplicationId) {
            const newStatus = column.getAttribute('data-status');
            
            // Update status via AJAX
            fetch(`/grants/applications/${draggedApplicationId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: `status=${newStatus}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove from old column
                    draggedElement.remove();
                    
                    // Update counts
                    updateColumnCounts();
                    
                    // Reload page to show updated status
                    location.reload();
                } else {
                    alert('Error updating application status');
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating application status');
                location.reload();
            });
        }

        return false;
    }

    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const content = column.querySelector('.kanban-column-content');
            const cards = content.querySelectorAll('.application-card');
            const count = cards.length;
            const countElement = column.querySelector('.kanban-column-count');
            if (countElement) {
                countElement.textContent = count;
            }
        });
    }

    // Add drag end handler
    document.addEventListener('dragend', function(e) {
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        document.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('drag-over');
        });
        draggedElement = null;
        draggedApplicationId = null;
    });

    // Make columns accept drops
    document.querySelectorAll('.kanban-column-content').forEach(content => {
        content.addEventListener('dragleave', handleDragLeave);
    });
</script>
{% endblock %}
