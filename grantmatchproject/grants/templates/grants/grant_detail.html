{% extends 'grants/base.html' %}
{% load static %}

{% block title %}{{ grant.title }} - Granted{% endblock %}

{% block content %}
<div class="grant-detail-page">
    <!-- Grant Header -->
    <div class="grant-detail-header">
        <div class="grant-header-left">
            <div class="grant-icon-large">
                {% if grant.icon_name %}
                    <span class="icon-{{ grant.icon_name }}">{{ grant.agency.acronym|slice:":1" }}</span>
                {% else %}
                    <span class="grant-icon-default">{{ grant.agency.acronym|slice:":1" }}</span>
                {% endif %}
            </div>
            <div class="grant-header-info">
                <div class="grant-agency-badge">{{ grant.agency.acronym }}</div>
                <h1>{{ live_data.title|default:grant.title }}</h1>
                <div class="grant-status-badges">
                    <span class="status-badge status-{{ grant.status }}">{{ grant.get_status_display }}</span>
                    {% if grant.duration_years %}
                    <span class="tag tag-blue">{{ grant.duration_years }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="grant-header-right">
            {% if match_score %}
            <div class="match-badge-large match-badge-high">{{ match_score }}% Match</div>
            {% endif %}
        </div>
    </div>

    <!-- Match Analysis Section -->
    {% if match_score > 0 %}
    <div class="match-analysis-section">
        <div class="match-analysis-grid">
            <!-- Why This Grant Matches -->
            <div class="match-box match-box-positive">
                <h3>Why This Grant Matches</h3>
                <ul class="match-reasons-list">
                    {% for reason in match_reasons %}
                    <li>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="8" fill="currentColor"/>
                            <path d="M6 10L9 13L14 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        {{ reason }}
                    </li>
                    {% empty %}
                    <li>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="8" fill="currentColor"/>
                            <path d="M6 10L9 13L14 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Strong alignment with your project focus areas
                    </li>
                    <li>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="8" fill="currentColor"/>
                            <path d="M6 10L9 13L14 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Budget range matches your requirements
                    </li>
                    <li>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="8" fill="currentColor"/>
                            <path d="M6 10L9 13L14 7" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Eligibility criteria fully met
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Why It May Not Match -->
            <div class="match-box match-box-warning">
                <h3>Why It May Not Match</h3>
                <ul class="match-reasons-list">
                    {% for reason in negative_reasons %}
                    <li>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M7 7L13 13M13 7L7 13" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        {{ reason }}
                    </li>
                    {% empty %}
                    <li>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M7 7L13 13M13 7L7 13" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Review specific eligibility requirements carefully
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grant-detail-content">
        <div class="grant-detail-main">
            <!-- Tabs Navigation -->
            <div class="grant-tabs">
                <button class="tab-button active" onclick="showTab('about')">About this grant</button>
                <button class="tab-button" onclick="showTab('who')">Who can apply</button>
                <button class="tab-button" onclick="showTab('when')">When to apply</button>
                <button class="tab-button" onclick="showTab('funding')">How much funding can you receive?</button>
                <button class="tab-button" onclick="showTab('how')">How to apply</button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- About Tab -->
                <div id="tab-about" class="tab-pane active">
                    <div class="detail-section">
                        <h2>About this Grant</h2>
                        {% if live_data.about_grant %}
                        <div class="grant-description">
                            {{ live_data.about_grant|linebreaks }}
                        </div>
                        {% elif live_data.description %}
                        <div class="grant-description">
                            {{ live_data.description|linebreaks }}
                        </div>
                        {% else %}
                        <div class="grant-description">
                            <p>{{ grant.description }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% if live_data.focus_area or grant.focus_area %}
                    <div class="detail-section">
                        <h2>Focus Area</h2>
                        <div class="focus-tags">
                            <span class="tag tag-purple">{{ live_data.focus_area|default:grant.focus_area }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Who Can Apply Tab -->
                <div id="tab-who" class="tab-pane">
                    <div class="detail-section">
                        <h2>Who Can Apply</h2>
                        {% if live_data.who_can_apply %}
                        <div class="eligibility-content">
                            {{ live_data.who_can_apply|linebreaks }}
                        </div>
                        {% elif live_data.eligibility_criteria %}
                        <div class="eligibility-content">
                            {{ live_data.eligibility_criteria|linebreaks }}
                        </div>
                        {% elif grant.eligibility_criteria %}
                        <div class="eligibility-content">
                            <p>{{ grant.eligibility_criteria }}</p>
                        </div>
                        {% else %}
                        <p>Please check the official grant page for detailed eligibility criteria.</p>
                        {% endif %}
                        {% if live_data.applicable_to %}
                        <div class="applicable-to">
                            <h3>Applicable To:</h3>
                            <ul>
                                {% for applicant_type in live_data.applicable_to %}
                                <li>{{ applicant_type|title }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- When to Apply Tab -->
                <div id="tab-when" class="tab-pane">
                    <div class="detail-section">
                        <h2>When to Apply</h2>
                        {% if live_data.when_to_apply %}
                        <div class="when-to-apply-content">
                            {{ live_data.when_to_apply|linebreaks }}
                        </div>
                        {% endif %}
                        <div class="timeline-info">
                            {% if grant.opening_date %}
                            <div class="timeline-item">
                                <strong>Opening Date:</strong> {{ grant.opening_date|date:"d M Y" }}
                            </div>
                            {% endif %}
                            <div class="timeline-item">
                                <strong>Closing Date:</strong> 
                                {% if grant.closing_date %}
                                    {{ grant.closing_date|date:"d M Y" }}
                                    {% if grant.days_until_deadline %}
                                        <span class="days-remaining">({{ grant.days_until_deadline }} days remaining)</span>
                                    {% endif %}
                                {% else %}
                                    {{ live_data.closing_date_text|default:"Open for Applications" }}
                                {% endif %}
                            </div>
                            {% if grant.duration_years %}
                            <div class="timeline-item">
                                <strong>Duration:</strong> {{ grant.duration_years }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Funding Tab -->
                <div id="tab-funding" class="tab-pane">
                    <div class="detail-section">
                        <h2>How Much Funding Can You Receive</h2>
                        {% if live_data.funding_info %}
                        <div class="funding-info-content">
                            {{ live_data.funding_info|linebreaks }}
                        </div>
                        {% elif live_data.funding_details %}
                        <div class="funding-info-content">
                            {{ live_data.funding_details|linebreaks }}
                        </div>
                        {% endif %}
                        <div class="funding-info">
                            <div class="funding-amount-large">
                                {{ grant.funding_range }}
                            </div>
                            {% if live_data.grant_amount_text %}
                            <p>{{ live_data.grant_amount_text }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- How to Apply Tab -->
                <div id="tab-how" class="tab-pane">
                    <div class="detail-section">
                        <h2>How to Apply</h2>
                        {% if live_data.how_to_apply %}
                        <div class="how-to-apply-content">
                            {{ live_data.how_to_apply|linebreaks }}
                        </div>
                        {% else %}
                        <p>Please visit the official grant page for detailed application instructions.</p>
                        {% endif %}
                        {% if live_data.required_documents %}
                        <div class="required-documents">
                            <h3>Required Documents</h3>
                            <div class="documents-content">
                                {{ live_data.required_documents|linebreaks }}
                            </div>
                        </div>
                        {% endif %}
                        {% if grant.application_url or live_data.application_url %}
                        <div class="apply-actions">
                            <a href="{{ live_data.application_url|default:grant.application_url }}" target="_blank" class="btn btn-primary">
                                Start Application
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="grant-detail-sidebar">
            <div class="quick-facts-card">
                <h3>Quick Facts</h3>
                <div class="fact-item">
                    <span class="fact-label">Funding Amount</span>
                    <span class="fact-value">{{ grant.funding_range }}</span>
                </div>
                <div class="fact-item">
                    <span class="fact-label">Deadline</span>
                    <span class="fact-value">
                        {% if grant.closing_date %}
                            {{ grant.closing_date|date:"d M Y" }}
                        {% else %}
                            {{ live_data.closing_date_text|default:"TBA" }}
                        {% endif %}
                    </span>
                </div>
                {% if grant.duration_years %}
                <div class="fact-item">
                    <span class="fact-label">Duration</span>
                    <span class="fact-value">{{ grant.duration_years }}</span>
                </div>
                {% endif %}
                <div class="fact-item">
                    <span class="fact-label">Agency</span>
                    <span class="fact-value">{{ grant.agency.acronym }}</span>
                </div>
                {% if live_data.focus_area or grant.focus_area %}
                <div class="fact-item">
                    <span class="fact-label">Focus Area</span>
                    <span class="fact-value">{{ live_data.focus_area|default:grant.focus_area }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-card">
                {% if grant.application_url or live_data.application_url %}
                <a href="{{ live_data.application_url|default:grant.application_url }}" target="_blank" class="btn btn-primary btn-block">
                    Start Application
                </a>
                {% endif %}
                <button class="btn btn-secondary btn-block" onclick="toggleSave({{ grant.id }})">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="{% if is_saved %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2">
                        <path d="M10 15L5 10L6.5 8.5L10 12L13.5 8.5L15 10L10 15Z"/>
                    </svg>
                    Save Grant
                </button>
                {% if grant.agency.website %}
                <a href="{{ grant.agency.website }}" target="_blank" class="btn btn-outline btn-block">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 3H5C3.89543 3 3 3.89543 3 5V15C3 16.1046 3.89543 17 5 17H15C16.1046 17 17 16.1046 17 15V9M14 2H17M17 2V5M17 2L8 11"/>
                    </svg>
                    Go to Agency Website
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Similar Grants Section -->
    {% if similar_grants %}
    <div class="similar-grants-section">
        <h2>Similar Grants</h2>
        <div class="similar-grants-grid">
            {% for similar in similar_grants %}
            <div class="similar-grant-card">
                <div class="similar-grant-header">
                    <div class="similar-grant-icon">
                        <span class="grant-icon-default">{{ similar.agency.acronym|slice:":1" }}</span>
                    </div>
                    <div class="similar-grant-info">
                        <h3>{{ similar.title }}</h3>
                        <div class="similar-grant-meta">
                            <span>{{ similar.funding_range }}</span>
                            <span>{{ similar.closing_date|date:"d M Y"|default:"TBA" }}</span>
                        </div>
                    </div>
                    {% if similar.match_score %}
                    <div class="match-badge match-badge-small">{{ similar.match_score }}%</div>
                    {% endif %}
                </div>
                <a href="{% url 'grants:grant_detail' similar.id %}" class="btn btn-outline btn-sm">View Details</a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up tab button click handlers
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.textContent.trim().toLowerCase()
                .replace('about this grant', 'about')
                .replace('who can apply', 'who')
                .replace('when to apply', 'when')
                .replace('how much funding can you receive?', 'funding')
                .replace('how to apply', 'how');
            
            showTab(tabName);
        });
    });
});

function showTab(tabName) {
    // Hide all tab panes
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab pane
    const targetPane = document.getElementById('tab-' + tabName);
    if (targetPane) {
        targetPane.classList.add('active');
    }
    
    // Add active class to clicked button
    if (event && event.target) {
        event.target.classList.add('active');
    }
}

function toggleSave(grantId) {
    fetch(`/grants/${grantId}/save/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    }).then(() => {
        location.reload();
    });
}
</script>
{% endblock %}
